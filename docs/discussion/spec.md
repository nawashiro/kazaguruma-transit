## コンセプト

意見収集プラットフォームを作成する。千代田区福祉交通「風ぐるま」利用にあたる経験の広範な収集を目的とする。悪意のある投稿を防ぐため、モデレーターによる投稿の審査を必要とする。ユーザーはモデレーターによる操作を監査できる。

## 使用技術

Nostr プロトコルを使用する。投稿はリレーサーバーに分散して保存され、削除に耐性を持つ。電子署名によって改ざんに耐性を持つ。基本プロトコルフローは [NIP-01](NIP-01.md) を参照のこと。[nostr-tools](nostr-tools.md) を SDK として使う。[NIP-72](NIP-72.md) は Reddit 形式のディスカッションに関する仕様だ。[nosskey-sdk](nosskey.md) を使用して、アカウント作成・鍵管理を Passkey で行う。

## 用語

- 管理者: 一人存在する。環境変数で公開鍵を指定する。
- モデレーター: 複数人存在する。kind 34550 で指定する。
- ディスカッション: 管理者が作成した kind 34550 イベント。

## UI 要件

基本原則として、署名を要する何らかの操作を未ログインの状態で試みると、ログイン・新規登録を求められる。

監査画面のタイムラインには DaisyUI の Timeline コンポーネントを使う。日付を表示する。モデレーターの名前のみ公開する。

フォームは DaisyUI の Text Input や Textarea を使う。

### ディスカッション一覧

- ディスカッション一覧画面
  - ディスカッションのタイトルが最新のものから一覧される。
  - ユーザーは管理者へ新たなディスカッションをリクエストできる。フォームがあり、submit すると管理者へメンションされる。
- ディスカッション一覧に対する監査画面
  - 管理者へのディスカッションリクエストとディスカッション作成の履歴がタイムラインとして表示される。
- ディスカッション作成・削除画面
  - 管理者のみ操作可能。そもそも管理者以外がディスカッション作成操作をしてもディスカッション一覧画面は表示しないため、公開鍵に対する簡素な if でよい。
  - リクエスト一覧コンポーネント: ユーザーからのリクエストを一覧する。
  - ディスカッション一覧コンポーネント: 作成したディスカッションを一覧し、kind 34550 イベントを編集・削除することができる。
  - ディスカッション作成コンポーネント: フォームがあり、ディスカッションを作成することができる。

### ディスカッション

基本原則として、先入観や射幸心を防ぐため、投稿は本文のみ表示され、投稿者の名前や評価値は表示されない。`t` タグの内容は DaisyUI の Badge で表示される。

管理者が作成したディスカッション以外は表示しない。公開鍵との簡素な比較で実現できる。

- ディスカッション画面
  - ディスカッションの説明が表示される。
  - 評価実行コンポーネント: ディスカッションに対するモデレーターに承認された投稿の一覧がランダムな順序で表示され、賛成・反対で評価できる。評価すると、表示は消える。以後アクセスしたときにも、nostr 上に評価した記録があれば表示しない。
  - 高評価コンポーネント: モデレーターに承認された投稿の一覧が全ユーザの評価に基づいて、評価が高い順にソートされる。
  - 投稿コンポーネント: フォームがあり、投稿できる。モデレーターによる承認ののち表示される旨が説明されている。
    - 任意で `t` タグにバス停名を含めることができる。DaisyUI の Select コンポーネントを使う。全てのバス停がひとつの Select に表示されると探すのが困難なため、ルートから絞り込む。投稿の前にプレビューがある。DaisyUI の Badge によってタグに設定されたバス停名が表示される。
- ディスカッションに対する監査画面
  - 未承認を含む投稿とモデレーターによる承認の履歴がタイムラインとして表示される。
- ディスカッションに対する投稿の承認・承認の撤回画面
  - モデレーターのみ操作可能。そもそもモデレーター以外が承認操作をしてもディスカッション画面は表示しないため、公開鍵に対する簡素な if でよい。
  - 未承認投稿一覧コンポーネント: 未承認の投稿が一覧され、承認操作ができる。
  - 承認済み投稿一覧コンポーネント: 承認済みの投稿が一覧され、承認の撤回ができる。

### ホーム画面

- ホーム画面のルート検索結果は「東日本銀行神田支店 10:36」のように表示されるが、この下に環境変数で指定された「バス停ごとの話題ディスカッション」に投稿され、かつ `t` タグがバス停名と一致しており、かつすべてのユーザーから最も評価が高いもののテキストを表示する。
- 印刷ボタンのさらに下に、投稿コンポーネントを追加する。`t` タグにはバス停名が含まれ、環境変数で指定された「バス停ごとの話題ディスカッション」に投稿される。含めるバス停名はルート検索結果に含まれるものを候補として、 DaisyUI の Select で選択する（必須）。投稿の前にプレビューがある。
- さらに下に「バス停ごとの話題ディスカッション」に投稿されたルート検索結果に含まれるバス停名と一致する `t` タグをもつ投稿がランダムに並び、評価できる。評価実行コンポーネントと同様のもので、イベント取得条件のみが異なるため、共通コンポーネントとして実装する。

### 設定画面

- 未ログイン時:
  - ログインボタン: クリックするとログイン・新規登録モーダルが表示される。
- ログイン時:
  - ログアウトボタン: ログイン時に表示される。クリックするとキャッシュがブラウザから削除され、ログアウトする。
  - アカウント名

### 共通コンポーネント

- ログイン・新規登録モーダル: Nosskey によるログイン・あるいは新規登録を求める。新規登録時はユーザー名を求め、その名前で Passkey を作成し、 kind 0 を発行する。
- 投稿プレビュー
- 評価実行コンポーネント

kind0 の例:

```json
{
  "kind": 0,
  "content": "{\"name\":\"Alex Gleason\"}",
  "pubkey": "79c2cae114ea28a981e7559b4fe7854a473521a8d22a66bbab9fa248eb820ff6",
  "created_at": 1682790000
}
```

## 画面遷移

### ディスカッション一覧

- ディスカッション一覧 ←→ ディスカッション一覧に対する監査画面
  - タブ（DaisuUI の join による）により遷移
- ディスカッション一覧 → ディスカッション作成・削除画面
  - 公開鍵が管理者の場合にのみリンクを表示
- ディスカッション一覧 → ディスカッション

### ディスカッション

- ディスカッション画面 ←→ ディスカッションに対する監査画面
  - タブにより遷移
- ディスカッション画面 → ディスカッションに対する投稿の承認・承認の撤回画面
  - 公開鍵がモデレーターの場合にのみリンクを表示

### 設定画面

ナビゲーションに追加。

## URI

ディスカッションページの `[id]` には NIP-72 の community-d-identifier を使用する。

## リレーサーバー

環境変数でリレーサーバーを複数指定する。
