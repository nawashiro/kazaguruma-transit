# Issue #27 実装計画（受信から表示までの遅延解消）

## 課題認識
- `NostrService.getEvents` が `SimplePool.querySync` を使って全リレーの EOSE を待ち、部分結果が UI に出るまでブロックされているため、`/discussions/manage` などで「アクセス権限がありません」が一時的に出るなど UX が悪化している。
- `getApprovals` など全取得が必要なケースと、到着次第描画してよいケースが同一の API にまとまり、用途ごとの待機方針を切り替えられない。
- dedupe/sort が各所に散在し、ストリーミング経路で同等の整形を再利用しづらい。

## ゴール
- 送受信フローを「全部そろえる（EOSE待ち）」と「届き次第流す」に分離し、用途に応じて使い分けられる API を用意する。
- UI 側では、待たなくてよい通信で即座に初期表示できるようにし、`/discussions/manage` の誤警告を解消する。
- 重複排除とソートを共通ユーティリティ化し、両経路で一貫したデータ整形を行う。

## 実装方針（タスク）
1. **NostrService API の二系統化**
   - 既存 `getEvents` を「EOSE まで集約」する関数（例: `getEventsOnEose`）として明確化し、用途限定で使用する。
   - `SimplePool.subscribeMany` ベースのストリーミング関数（例: `streamEventsOnEvent`）を新設。`onEvent` を即時呼び、`onEose`/タイムアウト/購読解除を備えてメモリリークを防ぐ。
2. **共通整形ユーティリティ**
   - `event.id` 重複排除と時系列ソートのロジックをヘルパー関数として切り出し、EOSE 版・ストリーミング版双方で再利用できるようにする。
3. **呼び出し側の使い分け**
   - EOSE が必要な箇所: `src/app/discussions/[naddr]/page.tsx` での 4550 取得のみ（issue コメント準拠）。ここは `getEventsOnEose` を明示使用。
   - それ以外の `getApprovals`/`getDiscussionPosts` 等はストリーミング経路に移行し、部分結果を随時反映するようにリファクタ。`/discussions/manage` のパーミッション判定もこの経路で即時化。
   - API 名・シグネチャ変更に伴い、既存モック/テストの置換と型調整を行う。
4. **TDD での検証**
   - 新 API/ユーティリティの単体テストを先に作成し、EOSE 待ち/ストリーミング/タイムアウト/重複排除の振る舞いをモックした `SimplePool` で確認。
   - `discussions/manage`（権限判定が遅延するケース）の挙動をモックしたコンポーネントテストでカバーし、初期描画がブロックされないことを確認。

## テスト計画
- `src/lib/nostr/__tests__/nostr-service.test.ts`（新規）で:
  - `getEventsOnEose` が `querySync` を経由し、重複排除/ソートを適用すること。
  - `streamEventsOnEvent` がイベント到着ごとにコールバックを呼び、EOSE またはタイムアウト後に購読解除すること。
- コンポーネント側（例: `discussions/manage/page`）のテスト追加/更新で、ストリーミング経路をモックしつつ初期表示が即時に更新されること、誤った権限エラーが出ないことを検証。

## リスクと確認事項
- `SimplePool` のモック方法が複雑になりがちなので、テスト用の軽量モック層を用意してから実装する。
- どの呼び出しが「完全一致必須」かは追加で再点検し、意図と違う切替がないか実装時に再確認する（特に 34550/0 取得系）。
- ストリーミング切替に伴う状態更新の race を避けるため、解除ハンドラ/タイムアウト/クリーンアップを厳密に扱う。
