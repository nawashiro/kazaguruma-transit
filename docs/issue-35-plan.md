# #35 会話ページの読み込み遅延改善 計画

## 目的・意図の理解

- 読み込みが遅い原因は「不要なEOSE待ち」と「冗長なリクエスト順序」にある。
- 会話一覧は `4550 → 34550` の順で取得し、`4550` はEOSE待ち、最後の `34550` はOnEventで逐次描画する。
- 会話詳細は `34550` をOnEventで先に表示し、`4550` と `7` はEOSE待ち。`4550 → 7 → 合意分析` のウォーターフォールは一度だけ実行する。

## 現状の把握（第三者視点）

- `src/app/discussions/page.tsx` は事実上 `34550 → 4550 → 34550` の順で取得している。
  - 先頭の `34550` は `NEXT_PUBLIC_DISCUSSION_LIST_NADDR` のメタ検証用で、表示には直接寄与しない。本来は不要で、削除すべき。
  - 承認イベント取得後に `getReferencedUserDiscussions` で再度 `34550` をEOSE待ちしており、描画が遅い。
- `src/app/discussions/[naddr]/page.tsx` は `getDiscussion` と `getApprovalsOnEose` を `Promise.all` で待ち、UI全体がEOSE待ちでブロックされる。
  - `34550` と `4550` の同時開始はできているが、最初に表示できるタイトル/説明が遅延する。

## 専門家視点での問題点（忌憚なく）

- **不要なEOSE待ち**: 34550のメタ情報は早く出せるのに、ページ全体が待つ設計。
- **ウォーターフォールの固定化**: `4550 → 7 → 合意分析` が重く、ストリーミング更新に引きずられて再計算されるリスク。
- **UIの責務が一枚岩**: 「メタ取得」「承認取得」「評価取得」を一つの `isLoading` で管理しており、段階的描画ができない。
- **購読の終了条件の曖昧さ**: 連続読み込み時に古いストリームが残ると、状態競合を招く。

## 指針（Readable Code / 禅の精神）

- **単一責任**: メタ取得、承認取得、評価取得を分割して状態を持つ。
- **早く見せる**: 34550はOnEventで即描画し、EOSEは必要なものだけに限定。
- **シンプルな流れ**: `4550(EOSE) → 7(EOSE) → 合意分析(1回)` を明示的にガードする。

## 実装計画（TDD前提）

### 1. テストを先に追加

- 会話一覧ページの新規テスト（例: `src/app/discussions/__tests__/page.streaming.test.tsx`）
  - `4550` のEOSE完了までは `34550` の参照取得を始めない。
  - `34550` はOnEventで到着した順に描画され、EOSE待ちでブロックされない。
  - 初回の `34550` メタ検証リクエストがなくなることをモックで検証。
- 会話詳細ページのテストを追加/修正（`src/app/discussions/[naddr]/__tests__/page.test.tsx`）
  - `34550` の最初のイベント到着でタイトル/説明が表示される。
  - `4550` と `7` はEOSE完了まで待つ。
  - 合意分析はEOSE確定後に一度だけ実行される。

### 2. 失敗を確認

- `npm test` で新規テストが失敗することを確認。
- EOSE待ちがなくても描画が遅い現状を再現（テスト上で検出）。

### 3. 実装

- `src/lib/nostr/nostr-service.ts`
  - `getReferencedUserDiscussions` に対応する **ストリーミング版** を追加（例: `streamReferencedUserDiscussions`）。
  - `streamDiscussionMeta` など、`34550` をOnEventで取れる薄いAPIを追加（責務の分離）。
- `src/app/discussions/page.tsx`
  - 取得フローを `4550(EOSE) → 34550(ON_EVENT)` に変更。
  - `approvalStreamCleanupRef` と同様に `discussionStreamCleanupRef` を追加し、再ロードやアンマウント時に必ず解除。
  - EOSE前提の更新とOnEvent更新の混在を避け、状態更新は一方向に限定。
- `src/app/discussions/[naddr]/page.tsx`
  - `isLoading` を分割（例: `isDiscussionLoading`, `isPostsLoading`）し、メタ情報は先に描画。
  - `34550` はOnEventでセットし、`4550` はEOSE待ちで承認・投稿を確定。
  - `4550` 完了後に `7` を取得し、合意分析は1回のみ実行。

### 4. 成功までの流れ

- `npm test` が通ることを確認。
- `npm run lint` でLint違反なし。
- `npm run build` でビルドが通ることを確認。
- 体感で会話ページが即時表示されることを確認（手動確認）。

## 追加のリスク・検討事項（第三者視点）

- 参照数が多い場合、`streamEventsOnEvent` に大量フィルタを渡すとリレー側で弾かれる可能性。
  - 必要ならバッチングや上限設定を検討。
- ストリームの再起動が多いと `analysisResult` の再計算が起きるリスク。
  - `analysisResult` の計算を「承認取得完了後1回」に固定するガードが必要。
- UI描画中に `discussionInfo` が変わる可能性（URL遷移時）の競合を防ぐため、最新ロードのみ反映する仕組みを入れる。

## 前提と質問

- 34550のメタ検証を完全に削除して問題ないか（存在しない会話の扱い）。
- 会話一覧は「全ての承認イベント取得後に表示開始」で良いか、それとも一部でも即表示したいか。
- 評価(7)の取得は現状どおり全件EOSE待ちでよいか、増分評価の導入が必要か。
