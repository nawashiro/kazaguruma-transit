# #35 会話ページの読み込み遅延と監査ログ欠落の改善計画

## 目的・意図の理解

- 会話一覧は `4550 → 34550` の順で取得し、`4550` はEOSE待ち、`34550` はOnEventで逐次描画する。
- 会話詳細は `34550` をOnEventで先に表示し、`4550` と `7` はEOSE待ち。`34550` のEOSEを待たずに進める。
- 監査ログは `1/1111/4550/34550` を網羅して表示されるべき。現状「34550しか読み込まれていない」可能性があるので要再現・是正。

## 第三者視点での現状リスク（自己疑念を含む）

- **不要なEOSE待ち**: メタ情報(34550)は先に出せるのに、UI全体が待つ設計が残っているかもしれない。
- **監査ログの欠落**: コメント報告では `1/1111/4550` が読み込まれず、監査ログが空になる。自分の理解違いも疑い、実際の購読条件を必ず追う。
- **ウォーターフォールの暴発**: `4550 → 7 → 合意分析` がストリーミング更新で再実行されると重くなる。再実行を防げているかは要検証。
- **ロード順の競合**: 連続読み込み/タブ切替で古いストリームが残ると状態競合や誤表示が起きる。

## リーダブルコード / 禅の指針

- 単一責務: メタ取得、承認取得、評価取得、監査ログ取得を分離。
- 早く見せる: 34550はOnEventで即描画、EOSEは必要なものだけ。
- 透明な流れ: `4550(EOSE) → 7(EOSE) → 合意分析(1回)` を明示的にガード。
- 余計な検証は捨てる: naddrから派生できる情報は再取得しない。

## 実装計画（TDD前提）

### 1) テストを先に追加

- 会話一覧ページ（`src/app/discussions/__tests__/page.streaming.test.tsx`）
  - `4550` のEOSE完了までは `34550` の参照取得が始まらない。
  - `34550` はOnEventで逐次描画され、EOSE待ちでブロックされない。
  - 不要な `34550` 事前リクエスト（メタ検証）が発生しない。
- 会話詳細ページ（`src/app/discussions/[naddr]/__tests__/page.streaming.test.tsx`）
  - `34550` が1件でも到着したらタイトル/説明が即時表示される。
  - `4550` と `7` はEOSE完了まで待つ。
  - 合意分析はEOSE確定後に一度だけ実行される。
- 監査ログ（`src/app/discussions/__tests__/page.audit.test.tsx` と `src/components/discussion/__tests__/AuditLogSection.test.tsx` の追加）
  - `1/1111/4550` が購読され、`34550` は参照解決用にだけ使われる。
  - 監査ログが空のときでも読み込み状態が正しく遷移する。

### 2) 失敗を確認

- `npm test` で新規テストが失敗することを確認。
- 監査ログ欠落の再現（テストで 1/1111/4550 が取得されないことを検出）。

### 3) 実装（分割・シンプルに）

- `src/lib/nostr/nostr-service.ts`
  - 既存APIの責務を整理し、`34550` のOnEvent取得は `streamDiscussionMeta` に集約。
  - `streamReferencedUserDiscussions` のOnEvent利用を明示し、一覧描画の逐次更新に使う。
- `src/app/discussions/page.tsx`
  - 取得フローを `4550(EOSE) → 34550(ON_EVENT)` に一本化。
  - `loadSequenceRef` と cleanup を強化して古いストリームを確実に破棄。
  - 監査ログタブ切替で `AuditLogSection` を確実に発火させる。
- `src/app/discussions/[naddr]/page.tsx`
  - `isLoading` を分割し、メタは先に描画。
  - `4550` 完了後に `7` を取得し、合意分析は一度だけ実行するガードを追加。
- `src/components/discussion/AuditLogSection.tsx`
  - 一覧監査ログで `1/1111/4550` の購読漏れがないか検査し、必要なら購読順序と状態更新を修正。
  - 参照解決（34550取得）は最小限にし、ログの主軸は投稿/承認イベントとする。

### 4) 成功までの流れ

- `npm test` を通す。
- `npm run lint` を通す。
- `npm run build` を通す。
- 会話一覧・詳細・監査ログで「表示が先に出る」「監査ログが空にならない」を手動確認。

## レッドチーム的な再点検項目

- ストリームの再起動で合意分析が再計算されないか。
- 監査ログの更新中に `discussionInfo` が変わった時、古いデータが混入しないか。
- EOSEが来ないリレーでもUIが固まらないか（タイムアウトの確認）。

## 前提・質問（自分の思い込み検証）

- 34550の事前メタ検証を完全削除して問題ないか（存在しない会話の扱い）。
- 監査ログは「全件EOSE後に表示」で良いか、それともストリーミング表示が必要か。
- 評価(7)の取得は全件EOSE待ちで良いか、増分評価が必要か。
