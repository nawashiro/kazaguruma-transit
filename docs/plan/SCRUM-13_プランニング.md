# SCRUM-13: ルート検索アルゴリズムの最適化と徒歩距離オプション

## チケット情報

- **タイプ**: Story
- **ストーリーポイント**: 8
- **優先度**: Medium
- **コンポーネント**: TransitManager, UI/検索フォーム

## 注意

この記事は古い内容です。検索オプションは実装しないことになりました。かわりに、既存の探索アルゴリズムに加え、それで結果が得られなかったときのために、500m 以内のバス停について扱うロジックを組みます。

## 目的

ユーザーの移動ニーズに合わせて、徒歩距離を最小化するルート検索オプションを提供し、特に移動に制約のある高齢者や身体障害者のユーザーエクスペリエンスを向上させる。

## 実装概要

現在のルート検索アルゴリズムを拡張し、以下の機能を実装します：

1. ユーザーが「徒歩距離最小化」と「所要時間最小化」の検索オプションを選択できる UI を追加
2. 出発地と目的地周辺の複数のバス停を考慮した経路探索機能の実装
3. ハバーサイン公式を使用した正確な徒歩距離計算の実装
4. 徒歩距離と所要時間のバランスを考慮した最適ルート選択アルゴリズムの実装
5. 徒歩区間の詳細情報を視覚的に表示する機能の強化

## 技術的アプローチ

### フロントエンド変更

1. **検索フォームの拡張**:

   - `RouteSearchForm.tsx`コンポーネントに優先条件選択 UI を追加
   - 検索リクエストに優先条件パラメータを含める（デフォルトは所要時間優先、変更を保存する）

### バックエンド変更

1. **API 拡張**:

   - ルート検索 API に優先条件パラメータを追加
   - `/api/transit/routes.ts`エンドポイントの修正

2. **TransitService の拡張**:

   - 複数バス停考慮の検索ロジック実装
   - ハバーサイン公式による距離計算メソッドの追加
   - 最適経路選択アルゴリズムの実装

3. **地理的検索の最適化**:
   - バス停検索のパフォーマンス最適化
   - 検索半径のパラメータ化（デフォルト 600m）

## テスト計画

1. **単体テスト**:

   - 距離計算アルゴリズムの精度テスト
   - バス停検索ロジックのテスト
   - 最適ルート選択アルゴリズムのテスト

2. **統合テスト**:

   - 様々な出発地・目的地パターンでの経路検索テスト
   - エッジケース検証（近接バス停、同一バス停など）

3. **UI テスト**:
   - 検索オプションの動作確認
   - 経路表示の正確性確認
   - レスポンシブ対応確認

## リスクと対策

### リスク 1: パフォーマンス低下

複数バス停の組み合わせ検討による検索時間の増加

**対策**:

- バス停検索に地理的インデックスを適用
- 検討する組み合わせ数を制限（各地点から最も近い 5 つのバス停に限定）
- クエリキャッシュの導入検討

### リスク 2: アルゴリズム複雑性

徒歩距離と所要時間のバランスを取る最適ルート選定の複雑さ

**対策**:

- 明確な優先度判定ロジックの実装
- ユースケースに基づいた包括的なテスト
- 選択基準のドキュメント化

## 受け入れ基準

1. ユーザーは検索フォームで「徒歩距離最小化」または「所要時間最小化」のオプションを選択できる
2. 徒歩距離最小化モードでは、出発地から 600m 以内のすべてのバス停と目的地から 600m 以内のすべてのバス停を考慮した最適ルートが提示される
3. 検索結果には、所要時間が明確に表示される
4. アプリケーションのパフォーマンスが著しく低下しない（検索時間が 3 秒以内）

## 参考資料

- [ハバーサイン公式の実装](https://en.wikipedia.org/wiki/Haversine_formula)
- [GTFS 仕様](https://developers.google.com/transit/gtfs/reference)
- [TransitManager モジュール仕様](/src/lib/transit/transit-manager.ts)
- [交通データモデル](/src/lib/transit/models.ts)
