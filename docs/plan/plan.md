# SCRUM-13 プランニング: ルート検索アルゴリズムの最適化と徒歩距離オプション

## 1. 関連する OKR との結びつき

この機能はプロジェクトの以下の OKR に直接貢献します：

- **Objective 1: ユーザーエンゲージメントを強化し、継続的な利用を促進する**
  - Key Result 2: 平均エンゲージメント時間を 64.18 秒から 120 秒に伸ばす
  - 貢献内容: ユーザーの移動ニーズに合わせた検索オプションを提供することで、アプリの利便性を高め、利用時間の増加が期待できる

## 2. ユーザーストーリーとの関連性

この機能は主に以下のユーザーストーリーに関連しています：

- **ストーリー 3-1**: 「移動に制約のある高齢者として、徒歩距離が最小となる最適なバスルートを知りたい。自分の歩行能力に合った無理のない移動計画を立てられるようにするため」

- **ストーリー 3-2**: 「効率的に移動したい利用者として、少し歩くことで乗換回数や待ち時間が減る選択肢も提示してほしい。状況に応じて徒歩と乗車のバランスを取った移動ができるようにするため」

これらのストーリーは、異なるユーザーニーズ（徒歩距離の最小化と所要時間の最小化）に対応する機能を要求しています。

## 3. 実装の技術的アプローチ

現在のルート検索アルゴリズムを拡張し、以下の機能を実装します：

1. **検索オプションの追加**:

   - UI 上で「徒歩距離最小化」と「所要時間最小化」の選択肢を提供
   - 選択したオプションに基づいて検索アルゴリズムのパラメータを調整

2. **徒歩距離計算の改善**:

   - 出発地から 500m 以内のすべてのバス停を検索対象として考慮
   - 目的地周辺の 500m 以内のすべてのバス停も検索対象として考慮
   - ハバーサイン公式を使用した正確な徒歩距離計算の実装※既存の実装アリ

3. **ルート最適化アルゴリズムの拡張**:
   - まず従来のアルゴリズムで検索。ルートが見つからなかったときに、以下の新たなアルゴリズムを開始。
   - 徒歩距離最小化モード: 徒歩区間の総距離（30 分を超える理不尽な乗車時と乗り換え時の待ち時間ペナルティ+乗車時と降車時の徒歩時間+乗り換えペナルティ）を最小化するルートを優先
   - 所要時間最小化モード: 総所要時間（バス乗車時間+乗車時と乗り換え時の待ち時間+乗車時と降車時の徒歩時間）を最小化するルートを優先
   - 検索半径のパラメータ化（デフォルト値を 500m に設定）
   - 徒歩の速度は時速 3.6Km とする。これは後期高齢者の一般的な速さ。
   - 全ての定数は一か所で管理できるようにする

## 4. 見積もり（ストーリーポイント）の提案

**提案ストーリーポイント: 8**

理由:

- 既存のルート検索アルゴリズムの大幅な拡張が必要
- UI の変更と新しい検索オプションの追加
- 徒歩距離計算ロジックの実装と最適化
- 複数のバス停を考慮した経路探索アルゴリズムの複雑性
- テスト工数（正確な経路が計算されることの確認）

## 5. リスクと依存関係

### リスク

1. **パフォーマンスリスク**:

   - 検索対象バス停の増加によるクエリ処理時間の増大
   - 対策: バス停検索にインデックスを適切に設定し、地理的クエリを最適化

2. **アルゴリズム複雑性**:

   - 徒歩距離と所要時間のバランスを考慮した最適ルート選定が複雑
   - 対策: 明確な優先度付けロジックを設計し、ユースケースに基づいたテストを実施

3. **データ品質**:
   - 地理座標データの精度がルート計算の正確性に影響
   - 対策: バス停座標データの検証と、必要に応じた補正

### 依存関係

1. **地理計算ライブラリ**:

   - 既存のハバーサイン公式実装が必要（TransitManager.calculateDistance メソッド）

2. **データベース**:
   - Stop テーブル内の正確な地理座標データが必要
   - StopTime テーブルの完全なスケジュール情報が必要
