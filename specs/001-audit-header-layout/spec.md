# Feature Specification: 監査ページのヘッダー要素レイアウト移動

**Feature Branch**: `001-audit-header-layout`
**Created**: 2026-01-15
**Status**: Draft
**Input**: User description: "@001-audit-page-refactor/ この仕様に以前行った作業の詳細がある。監査画面のバグ修正・リファクタリングだ。この仕様によって、現在はレイアウトにタブ（トグルスイッチ）が実装されている。前の画面に戻るリンク・会話のタイトル・説明がメインに表示されているが、レイアウト側に移動させてほしい。具体的には、トグルスイッチの上に置いて欲しい。"

> **Note**: この仕様は `.specify/memory/constitution.md` の原則に準拠して作成されています。特に、テスト駆動開発(TDD)、アクセシビリティ(WCAG 2.1 AA)、型安全性(TypeScript strict)を重視しています。

## 背景

001-audit-page-refactorの実装により、会話詳細ページと監査ページは以下のような構造になっている：

### 現在のアーキテクチャ

```
/discussions/[naddr]/layout.tsx
├── DiscussionTabLayout (タブナビゲーション)
    └── children (ページコンテンツ)
        ├── /discussions/[naddr]/page.tsx
        │   └── 戻るリンク、タイトル、説明、メインコンテンツ
        └── /discussions/[naddr]/audit/page.tsx
            └── 監査ログコンテンツ
```

### 現状の問題

会話詳細ページ（`/discussions/[naddr]/page.tsx`）では、以下の要素がメインコンテンツ内に配置されている：

1. **戻るリンク**: 会話一覧に戻る（502-507行目）
2. **会話タイトル**: `discussion.title`（509-511行目）
3. **会話説明**: `discussion.description`（553-557行目）

これらは会話ページと監査ページの両方で共通して表示されるべき要素であるため、現状では以下の問題がある：

- 監査ページ（`/discussions/[naddr]/audit/page.tsx`）では「監査ログ」タイトルのみ表示され、会話のコンテキスト情報（タイトル・説明）が表示されない
- ユーザーが監査ページにいる際、どの会話の監査ログを見ているか分かりにくい
- 戻るリンクが監査ページには表示されないため、ナビゲーションが不便

### 目標

これらの共通要素をレイアウトコンポーネント（`DiscussionTabLayout`）に移動し、タブナビゲーションの上に配置することで、会話詳細ページとその監査ページの両方で一貫したヘッダー情報を表示する。

**スコープ**: この機能は**会話詳細ページ（`/discussions/[naddr]`）とその監査ページ（`/discussions/[naddr]/audit`）のみ**を対象とする。会話一覧ページ（`/discussions`とその`/audit`）は対象外である。

## Clarifications

### Session 2026-01-15

- Q: この機能のスコープについて - 会話一覧ページと会話詳細ページで異なるレイアウトコンポーネントを使用するか？ → A: 会話一覧ページと会話詳細ページで異なるレイアウトコンポーネントを使用する
- Q: レイアウトコンポーネントでの会話データ取得が失敗した場合の動作は？ → A: エラーメッセージを表示し、タブナビゲーションは表示する（ユーザーは手動で別のページに移動できる）
- Q: 会話データ読み込み中のスケルトンローディング表示について - どの要素を表示するか？ → A: タブナビゲーションと戻るリンクのみを表示し、外部から取得する要素（タイトル、説明）は読み込み完了後に表示
- Q: レイアウトで取得した会話データをメインページでも使用する場合の重複取得を避ける方法は？ → A: レイアウトとメインページは独立してデータ取得し、ブラウザのキャッシュで重複を軽減
- Q: 監査ページで、レイアウトに会話タイトルを表示した後、ページ本体の「監査ログ」見出しをどう扱うか？ → A: 「監査ログ」見出しを削除し、会話タイトルのみを表示する（監査ログであることはタブで明示される）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 監査ページでの会話コンテキスト確認 (Priority: P1)

ユーザーが監査ページにアクセスした際、現在どの会話の監査ログを見ているのかを明確に理解できる。会話タイトルと説明がページ上部に表示され、監査ログであることはアクティブなタブで示されることで、監査ログのコンテキストを失わずに閲覧できる。

**Why this priority**: 監査ページでのユーザビリティ向上の核心機能。現状では監査ログのみ表示され、コンテキスト情報が欠落している。

**Independent Test**: 監査ページにアクセスし、ページ上部にタイトル・説明・戻るリンクが表示され、「監査ログ」タブがアクティブになっていることを確認することで、独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが監査ページ（`/discussions/[naddr]/audit`）にアクセスする, **When** ページが読み込まれる, **Then** 会話タイトルと説明がタブナビゲーションの上に表示され、「監査ログ」タブがアクティブである
2. **Given** ユーザーが監査ページにいる, **When** ページ本体を見る, **Then** 「監査ログ」見出しは表示されず、監査ログコンテンツが直接表示される
3. **Given** ユーザーが監査ページにいる, **When** 戻るリンクをクリックする, **Then** 会話一覧ページ（`/discussions`）に遷移する
4. **Given** ユーザーが会話ページと監査ページを切り替える, **When** タブを切り替える, **Then** タイトル・説明・戻るリンクは同じ位置に表示され続ける

---

### User Story 2 - 会話ページでの一貫したレイアウト (Priority: P1)

会話ページでも同様に、ヘッダー情報がレイアウトコンポーネントで管理されることで、コード重複が削減され、将来的なメンテナンスが容易になる。

**Why this priority**: リファクタリングによるコード品質向上とメンテナンス性の確保。

**Independent Test**: 会話ページにアクセスし、既存の表示が変わらず機能することを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが会話ページ（`/discussions/[naddr]`）にアクセスする, **When** ページが読み込まれる, **Then** タイトル・説明・戻るリンクが表示される（既存の動作と同じ）
2. **Given** ユーザーがページを閲覧中, **When** ブラウザウィンドウサイズを変更する, **Then** レスポンシブに適切に表示される

---

### User Story 3 - 作成者/モデレーター情報の適切な配置 (Priority: P2)

会話ページに表示される「あなたは作成者/モデレーターです」のaside要素は、会話固有の機能（編集・承認管理）に関わるため、メインコンテンツ側に残す。監査ページでは表示されない。

**Why this priority**: 機能的には正しく動作するが、配置の明確化により将来の混乱を防ぐ。

**Independent Test**: 作成者/モデレーターとしてログインし、会話ページでasideが表示され、監査ページでは表示されないことを確認する。

**Acceptance Scenarios**:

1. **Given** 作成者がログインして会話ページにアクセスする, **When** ページを閲覧する, **Then** タイトル・説明の後に「あなたは作成者です」のasideが表示される
2. **Given** 作成者がログインして監査ページにアクセスする, **When** ページを閲覧する, **Then** 「あなたは作成者です」のasideは表示されない

---

### Edge Cases

- 会話データの読み込み中は、タブナビゲーションと戻るリンクのみが表示され、タイトルと説明は読み込み完了後に表示される
- 会話データが見つからない場合、エラーメッセージを表示するが、タブナビゲーションと戻るリンクは維持する
- データ取得エラーが発生した場合、ユーザーは戻るリンクやタブを使って別のページに移動できる
- タイトルや説明が非常に長い場合でも、レイアウトが崩れない
- 複数行の説明文がある場合、適切に改行して表示される

## Requirements *(mandatory)*

### Functional Requirements

#### ヘッダー要素の移動（会話詳細ページのみ）

- **FR-001**: システムは会話詳細ページ（`/discussions/[naddr]`）のレイアウトコンポーネント（`DiscussionTabLayout`）で、戻るリンク（会話一覧へのリンク）を表示しなければならない
- **FR-002**: システムは会話タイトルをレイアウトコンポーネントで表示しなければならない
- **FR-003**: システムは会話説明をレイアウトコンポーネントで表示しなければならない
- **FR-004**: これらの要素はタブナビゲーションの上に表示されなければならない
- **FR-015**: 会話一覧ページ（`/discussions`）とその監査ページは、この機能の影響を受けず、既存のレイアウトを維持しなければならない

#### データ取得

- **FR-005**: レイアウトコンポーネントは、会話データ（kind:34550）を独自に取得しなければならない
- **FR-006**: 会話データの取得は、監査ページ（`audit/page.tsx`）の既存実装と同様の方法を用いなければならない
- **FR-007**: テストモード（`isTestMode`）での動作をサポートしなければならない
- **FR-017**: レイアウトとメインページは独立してデータを取得し、データ共有のためのContext実装は不要である

#### ローディング状態とエラー処理

- **FR-008**: 会話データ読み込み中は、タブナビゲーションと戻るリンクのみを表示し、タイトルと説明は読み込み完了後に表示しなければならない
- **FR-009**: 会話データが見つからない場合、「会話が見つかりません」メッセージを表示しなければならない
- **FR-010**: 無効なNADDRの場合、「無効な会話URL」メッセージを表示しなければならない
- **FR-016**: データ取得エラー時も、タブナビゲーションは表示され、ユーザーが手動で別のページに移動できなければならない

#### メインページのリファクタリング

- **FR-011**: 会話ページ（`[naddr]/page.tsx`）から、戻るリンク・タイトル・説明の表示コードを削除しなければならない
- **FR-012**: 会話ページは引き続き、作成者/モデレーター用のaside要素をメインコンテンツ内で表示しなければならない
- **FR-018**: 監査ページ（`[naddr]/audit/page.tsx`）から、「監査ログ」見出しを削除しなければならない（会話タイトルがレイアウトで表示され、監査ログであることはタブで明示される）

#### スタイリングと一貫性

- **FR-013**: レイアウトコンポーネントで表示される要素のスタイルは、既存の会話ページと同一でなければならない
- **FR-014**: ruby-textクラスを適用し、日本語テキストの適切なレンダリングを保証しなければならない

### Key Entities

- **DiscussionTabLayout**: タブナビゲーションとヘッダー要素を管理するレイアウトコンポーネント
- **Discussion**: 会話データ（kind:34550から取得、タイトル・説明・作成者情報を含む）
- **DiscussionInfo**: NADDRから抽出した会話識別情報（作成者pubkey、dTag、discussionId）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 会話詳細の監査ページにアクセスした際、会話タイトルと説明が表示される（表示率100%）
- **SC-002**: 会話詳細ページと監査ページで、戻るリンク・タイトル・説明が同じ位置（タブの上）に表示される
- **SC-003**: 既存の会話詳細ページの表示が変わらず、すべての機能が正常に動作する（後方互換性100%）
- **SC-004**: 会話一覧ページとその監査ページは影響を受けず、既存の表示を維持する
- **SC-005**: レイアウトコンポーネントのデータ取得処理は、3秒以内に完了する（通常のネットワーク環境下）
- **SC-006**: TypeScript型チェック（`npx tsc --noEmit`）がエラーなく通過する
- **SC-007**: すべてのテストが成功する

## Assumptions

- `DiscussionTabLayout`は既に`baseHref`パラメータを受け取っており、NADDR値にアクセスできる（`useParams`フック経由）
- `extractDiscussionFromNaddr`ユーティリティは正常に機能し、NADDRから必要な情報を抽出できる
- `createNostrService`と`nostrService.streamDiscussionMeta`は正常に機能する（既存実装で確認済み）
- 会話データ（kind:34550）は必ず存在する（存在しない場合はエラー表示で対応）
- 会話一覧ページ（`/discussions`とその`/audit`）は対象外であり、既存のレイアウトを維持する
- 会話一覧ページと会話詳細ページは異なるレイアウトコンポーネント構造を持つ

## Non-Functional Requirements

### パフォーマンス

- レイアウトコンポーネントでのデータ取得が、ページ全体のローディング時間に大きな影響を与えないこと
- レイアウトとメインページが独立してデータ取得するが、ブラウザキャッシュやNostrリレーの効率性により、実質的なネットワーク負荷は最小限であること
- 会話ページと監査ページ間のタブ切り替えがスムーズであること

### メンテナンス性

- 共通要素をレイアウトで一元管理することで、将来的な変更が容易であること
- コード重複を削減し、DRY原則に従うこと

### アクセシビリティ

- 既存のWCAG 2.1 AA準拠を維持すること
- スクリーンリーダーで適切に読み上げられること
