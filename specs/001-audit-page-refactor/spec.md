# Feature Specification: 監査ページリファクタリングと表示不具合修正

**Feature Branch**: `001-audit-page-refactor`
**Created**: 2026-01-14
**Status**: Draft
**Input**: User description: "監査画面表示不具合の修正と会話・監査ページの分離リファクタリング"

> **Note**: この仕様は `.specify/memory/constitution.md` の原則に準拠して作成されています。特に、テスト駆動開発(TDD)、アクセシビリティ(WCAG 2.1 AA)、型安全性(TypeScript strict)を重視しています。

## 背景と課題

### 現在の問題点

1. **監査画面の表示不具合**:
   - 会話一覧ページ(`/discussions`)の監査画面でコンテンツが表示されない
   - 会話詳細ページ(`/discussions/[naddr]`)で会話の作成イベントのみが表示され、投稿や承認の履歴が表示されない

2. **根本原因**（2026-01-13調査報告書より）:
   - `updateFromApprovals`関数でエラーハンドリングが欠如しており、エラー発生時にデータが設定されない
   - 投稿ストリームと承認ストリームが並行実行されるため、データの到着順序によっては空配列で処理される競合状態が発生
   - デバッグ情報が不足しており、問題特定が困難

3. **アーキテクチャの問題**:
   - メイン画面と監査画面が同一ページ内にタブ切り替えで実装されている
   - 異なる責務の機能が同じ画面に混在している
   - URLで監査画面を直接共有できない

### 現状のデータ取得アーキテクチャ

コード分析の結果、以下の依存関係を確認：

**会話詳細ページ (`[naddr]/page.tsx`)**:
- **メイン画面**: kind:34550（Discussion）を取得し、`discussion` stateに保存
- **監査画面（AuditLogSection）**:
  - kind:34550は**メイン画面からprops経由**で受け取る（`discussion={discussion}`）
  - kind:4550（Approval）とkind:1111/1（Posts）は独自にストリーミング

**会話一覧ページ (`discussions/page.tsx`)**:
- **メイン画面**: kind:4550から承認済み投稿を取得し、qタグで参照されたkind:34550を取得
- **監査画面（AuditLogSection）**: 独自にkind:4550とkind:1111/1をストリーミングし、qタグで参照されたkind:34550を取得

**依存関係の整理**:
- 会話詳細ページでは、監査画面がkind:34550をメイン画面から受け取っているため、**ページ分離時に監査ページでも独自にkind:34550を取得する必要がある**
- 会話一覧ページでは、監査画面は独自にデータ取得しているため、ページ分離の影響は少ない

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 監査履歴の閲覧（会話詳細） (Priority: P1)

ユーザーは特定の会話について、すべての投稿提出と承認の履歴をタイムラインで確認できる。会話の透明性を確保し、モデレーション操作を監査できることで、ユーザーはプラットフォームを信頼できる。

**Why this priority**: 監査機能はプラットフォームの透明性と信頼性の根幹であり、現在表示されない不具合を修正することが最優先。

**Independent Test**: 会話詳細の監査ページにアクセスし、投稿提出・承認イベントがタイムラインに表示されることを確認することで、独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが投稿と承認が存在する会話の監査ページにアクセスする, **When** ページが読み込まれる, **Then** 投稿提出イベントと承認イベントがタイムスタンプ順でタイムラインに表示される

2. **Given** 監査タイムラインが表示されている, **When** 各イベントを確認する, **Then** 会話作成者とモデレーターにはバッジ（作成者/モデレーター）が表示され、一般ユーザーの名前は表示されない

3. **Given** ユーザーが会話詳細ページを閲覧中, **When** 監査タブを選択する, **Then** URLが`/discussions/[naddr]/audit`に変わり、監査専用ページに遷移する

4. **Given** 監査ページのURLを直接入力, **When** ページにアクセスする, **Then** 正常に監査ページが表示される（ブックマーク・共有可能）

---

### User Story 2 - 会話一覧への収録リクエストの監査（会話一覧） (Priority: P1)

ユーザーは会話一覧への収録リクエストが適切に処理されているかを監査できる。ユーザー作成の会話を会話一覧に収録するようリクエストした際、そのリクエストが不当に黙殺されていないかを確認できる。

**Why this priority**: 会話詳細と同様に監査機能の不具合修正が必要であり、同じ優先度で対応すべき。会話一覧への収録プロセスの透明性はプラットフォームの公平性を担保する。

**Independent Test**: 会話一覧の監査ページにアクセスし、収録リクエストと承認/却下がタイムラインに表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが会話一覧の監査ページにアクセスする, **When** ページが読み込まれる, **Then** 会話一覧への収録リクエストと、その承認/却下がタイムラインに表示される

2. **Given** 監査タイムラインで収録リクエストが表示される, **When** qタグで参照された会話を確認する, **Then** その会話へのリンクが表示され、クリックで遷移できる

3. **Given** ユーザーが会話一覧ページを閲覧中, **When** 監査タブを選択する, **Then** URLが`/discussions/audit`に変わり、監査専用ページに遷移する

---

### User Story 3 - 会話・監査タブの切り替え (Priority: P2)

ユーザーは会話コンテンツと監査ログを簡単に切り替えられる。タブUIは直感的で、現在どちらを見ているかが明確に分かる。

**Why this priority**: タブナビゲーションはページ分離の中核機能だが、会話詳細ページでは監査画面がkind:34550をメイン画面から受け取る依存関係があるため、ページ分離には監査ページ側でのkind:34550取得ロジック追加が必要。不具合修正（P1）の後に実装する。

**Independent Test**: 会話ページでタブを切り替え、URLが変わり、対応するコンテンツが表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが会話ページを閲覧中, **When** タブUIを見る, **Then** 「会話」「監査」の2つのタブがあり、現在アクティブなタブが視覚的に区別される

2. **Given** 会話タブがアクティブ, **When** 監査タブをクリックする, **Then** ページ遷移が発生し、監査ページに移動する（URLが変わる）

3. **Given** タブをキーボードで操作, **When** Tab/Enter/Arrowキーで操作する, **Then** アクセシブルにタブを切り替えられる（WCAG 2.1 AA準拠）

---

### User Story 4 - エラー時の適切なフィードバック (Priority: P2)

データ取得中にエラーが発生した場合、ユーザーに適切なフィードバックが表示される。

**Why this priority**: 不具合修正の一環として、エラー状態の可視化は重要だが、主要機能の修正後に対応。

**Independent Test**: ネットワークエラーをシミュレートし、エラーメッセージが表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** 監査データの取得中にエラーが発生, **When** エラーが検知される, **Then** ユーザーフレンドリーなエラーメッセージが日本語で表示される

2. **Given** エラーが発生した状態, **When** 再試行ボタンをクリック, **Then** データ取得が再試行される

---

### Edge Cases

- サーバー側の問題でデータが取得できない場合、「データが見つかりません」と表示される（会話作成イベントは必ず存在するはずなので、「活動がない」ではなくデータ取得の問題を示す）
- ストリーミング中にネットワークが切断された場合、適切なエラー状態に遷移し、再接続ボタンを表示する
- 承認データが投稿データより遅れて到着した場合でも、最終的に正しくマージされて表示される
- 非常に多くのイベント（数百件以上）がある場合でも、パフォーマンスが劣化しない

## Requirements *(mandatory)*

### Functional Requirements

#### ページ分離

- **FR-001**: システムは会話詳細の監査ページを`/discussions/[naddr]/audit`として独立したページで提供しなければならない
- **FR-002**: システムは会話一覧の監査ページを`/discussions/audit`として独立したページで提供しなければならない
- **FR-003**: 監査ページと会話ページはそれぞれ独立したURLを持ち、直接アクセス・ブックマーク・共有が可能でなければならない
- **FR-016**: 会話詳細の監査ページは、メイン画面に依存せず独自にkind:34550（Discussion）を取得しなければならない

#### タブナビゲーション

- **FR-004**: 会話/監査の切り替えタブは共通レイアウトコンポーネントとして実装され、すべての関連ページで一貫した位置に表示されなければならない
- **FR-005**: タブはキーボードアクセシブル（WCAG 2.1 AA）でなければならない
- **FR-006**: アクティブなタブは視覚的に明確に区別されなければならない

#### データ取得の堅牢化

- **FR-007**: 監査データ取得処理はtry-catchでラップされ、エラーをログに記録しなければならない
- **FR-008**: 承認ストリームのEOSE後に投稿ストリームを開始し、競合状態を防止しなければならない
- **FR-009**: データ取得エラー時は最低限の空データを設定し、ローディング状態を適切に終了しなければならない
- **FR-010**: 各データ取得段階（イベント数、パース成功数、最終データ数）をログ出力しなければならない

#### 監査タイムライン表示

- **FR-011**: 監査タイムラインは投稿提出、投稿承認、会話作成のイベントをタイムスタンプ順で表示しなければならない
- **FR-012**: 会話一覧の監査では、qタグで参照された個別会話へのリンクを表示しなければならない
- **FR-013**: プロファイル表示は会話作成者とモデレーターのみに限定し、一般ユーザーの名前は表示しない（プライバシー保護）

#### エラー処理とフィードバック

- **FR-014**: エラー発生時はユーザーに日本語で理解しやすいメッセージを表示しなければならない（「データが見つかりません」など）
- **FR-015**: エラー状態からの再試行機能を提供しなければならない

### Key Entities

- **AuditTimelineItem**: タイムラインに表示される監査イベント（種類、タイムスタンプ、関連データ）
- **AuditPageState**: 監査ページの状態（ローディング中、ロード完了、エラー）
- **TabLayoutProps**: タブレイアウトの設定（現在のパス、タブ設定）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 投稿と承認が存在する会話の監査ページで、すべてのイベントが正しくタイムラインに表示される（表示率100%）
- **SC-002**: 監査ページの初回表示が3秒以内に完了する（通常のネットワーク環境下）
- **SC-003**: ブラウザの戻る/進むボタンで会話ページと監査ページ間を正しく遷移できる
- **SC-004**: 監査ページのURLを直接入力してアクセスした場合に正常に表示される
- **SC-005**: エラー発生時にユーザーが状況を理解できるメッセージが表示され、再試行で復旧できる
- **SC-006**: タブ切り替えがキーボードのみで操作可能（アクセシビリティ）

## Assumptions

- 既存のAuditTimelineコンポーネントの表示ロジック自体は正常に動作する（調査報告書で確認済み）
- Nostrリレーからのイベント取得は正常に機能している（ネットワークログで確認済み）
- NIP-72の承認イベント(kind:4550)のcontent内に元投稿がJSON形式で含まれる仕様は変わらない

## Clarifications

### Session 2026-01-14

- Q: kind:34550とkind:4550は監査画面に紐づいているか? → A: kind:34550は会話詳細ページでメイン画面からprops経由で渡されている。kind:4550は監査画面で独自に取得。ページ分離時には監査ページで独自にkind:34550を取得する必要がある。
