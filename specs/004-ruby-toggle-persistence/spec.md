# Feature Specification: ふりがな（ルビ）表示トグルの永続化

**Feature Branch**: `004-ruby-toggle-persistence`
**Created**: 2026-02-04
**Status**: Draft
**Input**: User description: "ふりがな（ルビフルボタン）のトグルが永続的に記憶されず、再読み込みのたびにデフォルト（オン）になってしまう問題が発生しています。理想的な挙動は、例えばオフにしたら次の再読み込み後にもオフのままになることです。"

> **Note**: この仕様は `.specify/memory/constitution.md` の原則に準拠して作成されています。特に、テスト駆動開発(TDD)、アクセシビリティ(WCAG 2.1 AA)、型安全性(TypeScript strict)を重視しています。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ルビ表示の設定を記憶する (Priority: P1)

ユーザーがふりがな（ルビ）の表示/非表示を切り替えたとき、その設定がブラウザに記憶され、次回アクセス時にも同じ設定が適用される。

**Why this priority**: ユーザーの基本的な読みやすさの設定を記憶することは、UXの基本です。毎回設定し直すのは非常に煩わしいため、最優先で解決すべき問題です。

**Independent Test**: ルビトグルボタンをオフにし、ページを再読み込みした後もオフのままであることを確認することで、独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがサイトに初めてアクセスし、ルビ表示がデフォルトでオンになっている、**When** ルビトグルボタンをクリックしてオフにする、**Then** ルビが非表示になり、設定が記憶される
2. **Given** ユーザーがルビ表示をオフに設定している、**When** ページを再読み込みする、**Then** ルビ表示はオフのままである
3. **Given** ユーザーがルビ表示をオフに設定している、**When** 別のページに遷移し、元のページに戻る、**Then** ルビ表示はオフのままである
4. **Given** ユーザーがルビ表示をオンに設定している、**When** ページを再読み込みする、**Then** ルビ表示はオンのままである
5. **Given** ユーザーがルビ表示をオフに設定している、**When** ブラウザを閉じて再度開く、**Then** ルビ表示はオフのままである

---

### User Story 2 - デフォルト値の明確な提供 (Priority: P2)

初めてサイトにアクセスするユーザー（設定が記憶されていない状態）には、合理的なデフォルト値（ルビ表示オン）が提供される。

**Why this priority**: 初回ユーザーには適切なデフォルト値を提供する必要がありますが、これは既に実装されているため、既存の動作を維持するだけです。

**Independent Test**: ブラウザのローカルストレージをクリアし、サイトにアクセスしたときにルビ表示がオンになっていることを確認することで、独立してテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがブラウザのデータ（localStorage）をクリアした、**When** サイトにアクセスする、**Then** ルビ表示はデフォルトでオンになっている
2. **Given** ユーザーがプライベートブラウジングモードを使用している、**When** サイトにアクセスする、**Then** ルビ表示はデフォルトでオンになっている

---

### Edge Cases

- **localStorageが使用できない環境**: プライベートブラウジングモード、古いブラウザ、localStorageが無効化されている場合、システムは毎回デフォルト値（オン）を使用する
- **不正な値がlocalStorageに保存されている場合**: システムは不正な値を無視し、デフォルト値（オン）を使用する
- **複数のブラウザ/デバイスを使用**: ユーザーが異なるブラウザやデバイスでアクセスした場合、各環境で独立した設定が保存される（クロスデバイス同期は行わない）
- **ルビ表示の切り替え中にページ遷移**: トグルボタンをクリックした直後にページ遷移しても、設定は確実に保存される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ユーザーがルビトグルボタンを操作したとき、その状態（オン/オフ）をブラウザのローカルストレージに保存しなければならない
- **FR-002**: システムは、ページ読み込み時にローカルストレージからルビ表示設定を読み込み、RubyfulV2の初期化時に適用しなければならない
- **FR-003**: システムは、localStorageが使用できない環境では、デフォルト値（オン）を使用しなければならない
- **FR-004**: システムは、localStorageに保存されている値が不正な場合、デフォルト値（オン）を使用し、エラーをコンソールに記録しなければならない
- **FR-005**: システムは、ルビ表示設定の変更を即座に反映し、ユーザーが操作結果を確認できなければならない
- **FR-006**: システムは、保存されたルビ表示設定をサイト全体で共有し、すべてのページで同じ設定が適用されなければならない

### Key Entities

- **ルビ表示設定**: ユーザーのふりがな（ルビ）表示の設定を表す。オン（true）またはオフ（false）の状態を持つ
  - 保存場所: ブラウザのlocalStorage
  - キー名: 推奨は `rubyful-display-preference` など識別しやすい名前
  - 値: `"true"` または `"false"` の文字列形式

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがルビ表示をオフにした後、ページを再読み込みしても設定が保持される（100%の確率で）
- **SC-002**: ユーザーがルビ表示をオンにした後、ページを再読み込みしても設定が保持される（100%の確率で）
- **SC-003**: ルビ表示設定の変更が0.5秒以内にUIに反映される
- **SC-004**: 初めてサイトにアクセスするユーザーには、デフォルトでルビ表示がオンになっている
- **SC-005**: localStorageが使用できない環境でも、エラーなくデフォルト動作（ルビ表示オン）が提供される
- **SC-006**: 異なるページ間でルビ表示設定が一貫して適用される（ページ遷移しても設定が維持される）

## Assumptions

- RubyfulV2ライブラリは、初期化時に`defaultDisplay`オプションで表示状態を制御できる
- RubyfulV2ライブラリは、トグルボタンがクリックされたときにイベントを発火するか、状態の変更を検知できる仕組みを提供している（もし提供されていない場合は、DOMの変更を監視する必要がある）
- ユーザーのブラウザは最新のlocalStorage APIをサポートしている（IE11以降）
- クロスデバイス同期は要求されていない（各デバイスで独立した設定）

## Non-Goals

このフィーチャーでは以下を実装しません：

- クロスデバイス/クロスブラウザでの設定同期（サーバーサイド保存）
- ユーザーアカウントへの設定紐付け
- ルビ表示以外の設定の永続化
- RubyfulV2ライブラリの動作の変更やフォーク
- ルビのスタイル（フォントサイズ、色など）のカスタマイズ
